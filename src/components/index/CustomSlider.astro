---
import { StrapiBlocks } from "@sensinum/astro-strapi-blocks";
import type { ComponentSectionsTeam } from "../../schemas/strapi.graphql.zod";

interface Props {
    members?: ComponentSectionsTeam[];
}
const { members = [] } = Astro.props as Props;

const STRAPI_URL = import.meta.env.STRAPI_URL;
const list = members.filter(Boolean);

// Índice inicial: primer miembro con about no vacío; fallback 0
let startIdx = list.findIndex((m) => m?.about?.length);
startIdx = startIdx >= 0 ? startIdx : 0;
---

<section class="team-hscroll relative h-[100svh] isolate" data-start={startIdx}>
    <!-- Grid 42/58 -->
    <div class="grid h-full grid-cols-1 md:grid-cols-[42%_58%] items-center content-center gap-14 md:gap-10 px-[5vw]">
        <!-- PANE IZQUIERDO -->
        <aside class="pane-left relative z-10 order-2 md:order-1 md:sticky md:top-[10svh] self-start md:self-center">
            <div class="info max-w-[60ch] mx-auto md:mx-0 text-center md:text-left">
                <!-- Rol -->
                <p class="info-role" data-info-role aria-live="polite"></p>

                <!-- Nombre -->
                <h3 class="info-name mt-3 text-[clamp(2rem,3.5vw,3.2rem)] font-extrabold leading-[1.08] tracking-tight text-black text-center md:text-left" data-info-name aria-live="polite"></h3>

                <!-- Divider -->
                <div id="divider" class="mt-4 h-px w-1/2 mx-auto md:mx-0"></div>

                <!-- About -->
                <div class="about-wrap mt-4 text-center md:text-left" data-about-wrap>
                    {
                        list.map((m, i) => (
                            <div class="about-entry" data-about={i}>
                                {m?.about?.length ? <StrapiBlocks data={m.about} class="t t-description prose prose-neutral max-w-none text-[1.02rem] leading-relaxed text-black/80 prose-p:my-2 prose-h4:mt-4 prose-ul:my-2 prose-li:my-0.5" /> : <p class="text-black/50">Sin descripción disponible.</p>}
                            </div>
                        ))
                    }
                </div>

                <!-- Dots -->
                <div class="mt-5 flex items-center gap-2 justify-center md:justify-start" aria-hidden="true" data-dots>
                    {list.map((_, i) => <span class="dot h-2 w-2 rounded-full bg-black/15 transition-[transform,background] duration-200" data-dot={i} />)}
                </div>
            </div>
        </aside>

        <!-- PANE DERECHO -->
        <div class="pane-right relative order-1 md:order-2 flex md:h-full items-center justify-center">
            <div class="cards relative w-[70%] md:w-[60%] lg:w-[52%] max-w-[560px] aspect-[3/4] md:aspect-[4/5] will-change-transform"></div>

            <!-- Fuente de cards (se oculta luego) -->
            <div class="track flex h-full will-change-transform">
                <div class="gutter-start shrink-0" aria-hidden="true"></div>
                {
                    list.map((m, i) => {
                        const picture = m?.picture?.url ? new URL(m.picture.url, STRAPI_URL).href : "";
                        const color = "#EFEFEF";
                        const name = m?.full_name ?? "";
                        const role = m?.role ?? "";
                        return (
                            <article class="card relative rounded-[24px] overflow-hidden ring-1 ring-black/5 bg-white" data-idx={i} data-name={name} data-role={role} data-org={m?.organization || ""} style={`background:${color}`}>
                                {picture && <img src={picture} alt={name || "Team member"} class="absolute inset-0 h-full w-full object-cover [filter:saturate(1.02)]" loading="lazy" decoding="async" />}
                                <a href={`mailto:${m.email}`} class="badge absolute left-4 bottom-4 z-10 rounded-full backdrop-blur px-3 py-1 text-xs font-medium text-white/95 gradient-custom animate-gradient bg-opacity-20">
                                    {m.email}
                                </a>
                            </article>
                        );
                    })
                }
                <div class="gutter-end shrink-0" aria-hidden="true"></div>
            </div>
        </div>
    </div>
</section>

<!-- Spacer para el recorrido vertical -->
<div class="hspacer pointer-events-none" aria-hidden="true"></div>

<style>
    .info-role {
        display: block;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 0.78rem;
        color: rgba(0, 0, 0, 0.62);
        line-height: 1.2;
    }
    .team-hscroll {
        isolation: isolate;
        position: relative;
        z-index: 0;
        /* Mejora scroll/touch en iOS */
        touch-action: pan-y;
        -webkit-user-select: none;
        user-select: none;
        /* overscroll-behavior: contain;  // REMOVIDO: podía producir sensación de scroll interno en mobile */
    }
    .info {
        position: relative;
        z-index: 1;
    }
    .cards {
        contain: layout style;
    }
    .card {
        backface-visibility: hidden;
        transform-origin: 50% 60%;
        box-shadow: 0 12px 36px rgba(0, 0, 0, 0.1);
    }
    .badge {
        border: 1px solid rgba(255, 255, 255, 0.25);
    }
    .dot.is-active {
        background: #111;
        transform: scale(1.15);
    }

    /* ABOUT controlado por GSAP; dejamos posiciones absolutas */
    .about-wrap {
        position: relative;
        overflow: hidden;
    }
    .about-entry {
        position: absolute;
        inset: 0;
        opacity: 0;
        transform: translateY(6px);
        pointer-events: none;
        list-style-position: inside;
        padding-left: 1.1em;
    }

    .about-entry {
        list-style: disc !important;
    }

    /* Divider: mobile (oscuro centro -> transparente extremos), desktop (izq -> der) */
    #divider {
        background: radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.35) 0%, rgba(0, 0, 0, 0.28) 20%, rgba(0, 0, 0, 0.18) 34%, rgba(0, 0, 0, 0.08) 55%, rgba(0, 0, 0, 0) 70%);
    }
    @media (min-width: 768px) {
        #divider {
            background: linear-gradient(to right, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0));
        }
    }

    /* Hint para evitar jitter del pin en iOS: forzar capa de composición */
    @supports (-webkit-touch-callout: none) {
        .team-hscroll {
            transform: translateZ(0);
            will-change: transform;
        }
    }
</style>

<script src="../../scripts/components/CustomSlider.ts"></script>
